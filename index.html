<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>LeKimLam AI - HUD VISION SYSTEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Font Cyberpunk -->
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
    :root {
        --primary: #00f3ff; /* Cyan Cyberpunk */
        --warning: #ff0055; /* Red Alert */
        --bg-hud: rgba(10, 15, 20, 0.85);
    }
    
    body { 
        margin: 0; background: #000; overflow: hidden; 
        font-family: 'Share Tech Mono', monospace; 
    }

    /* Hiệu ứng lưới quét (Grid Overlay) */
    #grid-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: 
            linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none; z-index: 5;
    }

    /* Container chính */
    #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
    
    video { 
        position: absolute; width: 100%; height: 100%; 
        object-fit: cover; filter: contrast(1.1) saturate(1.2); /* Tăng độ tương phản cho giống phim */
    }
    
    canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; pointer-events: none; z-index: 10; }

    /* UI Layer */
    #ui-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }

    /* Top Bar */
    .top-hud {
        position: absolute; top: 0; left: 0; width: 100%; padding: 15px;
        display: flex; justify-content: space-between;
        background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        color: var(--primary); text-shadow: 0 0 5px var(--primary);
    }
    .system-status { font-size: 14px; display: flex; gap: 20px; }
    .blink { animation: blinker 1s linear infinite; }

    /* Controls */
    .controls {
        position: absolute; bottom: 30px; width: 100%;
        display: flex; justify-content: center; gap: 20px; pointer-events: auto;
    }

    button {
        background: rgba(0, 20, 30, 0.6); border: 1px solid var(--primary);
        color: var(--primary); padding: 10px 20px; font-family: 'Share Tech Mono';
        text-transform: uppercase; letter-spacing: 2px; cursor: pointer;
        backdrop-filter: blur(4px); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        transition: 0.3s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    button:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }

    @keyframes blinker { 50% { opacity: 0; } }

    /* Loading Screen */
    #loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: var(--primary);
    }
    .loading-bar {
        width: 200px; height: 4px; background: #333; margin-top: 20px;
        position: relative; overflow: hidden;
    }
    .loading-bar::after {
        content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%;
        background: var(--primary); animation: load 1s infinite ease-in-out;
    }
    @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

</style>
</head>
<body>

<div id="loader">
    <h1>SYSTEM INITIALIZING...</h1>
    <div class="loading-bar"></div>
    <p id="load-text">LOADING NEURAL NETWORK [MOBILENET_V2]...</p>
</div>

<div id="grid-overlay"></div>

<div id="viewport">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
</div>

<div id="ui-layer">
    <div class="top-hud">
        <div class="system-status">
            <span>SYS: <span style="color:#0f0">ONLINE</span></span>
            <span>CPU: <span id="fps-meter">0</span> FPS</span>
            <span>TARGETS: <span id="target-count">0</span></span>
        </div>
        <div class="blink">● REC</div>
    </div>

    <div class="controls">
        <button onclick="switchCamera()">[CAM_SWITCH]</button>
        <button onclick="toggleMode()">[MODE: HUD]</button>
    </div>
</div>

<script>
/**
 * LEKIMLAM ARCHITECTURE - HUD CORE
 */

// --- 1. ADVANCED DICTIONARY (TỪ ĐIỂN SIÊU CẤP) ---
const CODENAMES = {
    'person':       { name: 'BIO-UNIT: HUMAN', type: 'BIO', color: '#00f3ff' },
    'bicycle':      { name: 'VEHICLE: BICYCLE', type: 'MECH', color: '#ffaa00' },
    'car':          { name: 'VEHICLE: AUTO-4', type: 'MECH', color: '#ffaa00' },
    'motorcycle':   { name: 'VEHICLE: MOTO-2', type: 'MECH', color: '#ffaa00' },
    'airplane':     { name: 'AERIAL: PLANE', type: 'MECH', color: '#ff0055' },
    'bus':          { name: 'TRANSIT: BUS', type: 'MECH', color: '#ffaa00' },
    'train':        { name: 'TRANSIT: RAIL', type: 'MECH', color: '#ffaa00' },
    'truck':        { name: 'HAULER: TRUCK', type: 'MECH', color: '#ffaa00' },
    'boat':         { name: 'MARINE: VESSEL', type: 'MECH', color: '#00aaff' },
    'traffic light':{ name: 'SIGNAL: TRAFFIC', type: 'INFRA', color: '#ffff00' },
    'cat':          { name: 'FAUNA: FELINE', type: 'BIO', color: '#ff00ff' },
    'dog':          { name: 'FAUNA: CANINE', type: 'BIO', color: '#ff00ff' },
    'horse':        { name: 'FAUNA: EQUINE', type: 'BIO', color: '#ff00ff' },
    'backpack':     { name: 'STORAGE: PACK', type: 'OBJ', color: '#00ff00' },
    'umbrella':     { name: 'SHIELD: RAIN', type: 'OBJ', color: '#00ff00' },
    'bottle':       { name: 'CONTAINER: FLUID', type: 'OBJ', color: '#00ff00' },
    'cup':          { name: 'VESSEL: DRINK', type: 'OBJ', color: '#00ff00' },
    'fork':         { name: 'TOOL: FEEDING', type: 'OBJ', color: '#cccccc' },
    'knife':        { name: 'WEAPON: BLADE', type: 'WARN', color: '#ff0000' },
    'spoon':        { name: 'TOOL: SCOOP', type: 'OBJ', color: '#cccccc' },
    'bowl':         { name: 'VESSEL: BOWL', type: 'OBJ', color: '#cccccc' },
    'banana':       { name: 'FLORA: FRUIT-Y', type: 'BIO', color: '#ffff00' },
    'apple':        { name: 'FLORA: FRUIT-R', type: 'BIO', color: '#ff0000' },
    'sandwich':     { name: 'RATION: BREAD', type: 'BIO', color: '#ffaa00' },
    'orange':       { name: 'FLORA: CITRUS', type: 'BIO', color: '#ffaa00' },
    'chair':        { name: 'STRUCT: SEAT', type: 'INFRA', color: '#00aaff' },
    'couch':        { name: 'STRUCT: SOFA', type: 'INFRA', color: '#00aaff' },
    'potted plant': { name: 'FLORA: DECOR', type: 'BIO', color: '#00ff00' },
    'bed':          { name: 'STRUCT: SLEEP', type: 'INFRA', color: '#00aaff' },
    'tv':           { name: 'DEVICE: DISPLAY', type: 'TECH', color: '#00f3ff' },
    'laptop':       { name: 'DEVICE: PORTABLE-PC', type: 'TECH', color: '#00f3ff' },
    'mouse':        { name: 'INPUT: MOUSE', type: 'TECH', color: '#00f3ff' },
    'remote':       { name: 'CTRL: REMOTE', type: 'TECH', color: '#00f3ff' },
    'keyboard':     { name: 'INPUT: KEYBOARD', type: 'TECH', color: '#00f3ff' },
    'cell phone':   { name: 'DEVICE: SMART-COM', type: 'TECH', color: '#00f3ff' },
    'book':         { name: 'DATA: PHYSICAL', type: 'OBJ', color: '#ffffff' },
    'clock':        { name: 'CHRONO: METER', type: 'TECH', color: '#ffffff' },
    'vase':         { name: 'DECOR: CERAMIC', type: 'OBJ', color: '#ffffff' },
    'scissors':     { name: 'TOOL: CUTTER', type: 'WARN', color: '#ff0055' },
    'teddy bear':   { name: 'TOY: PLUSH', type: 'OBJ', color: '#ff00ff' },
    'toothbrush':   { name: 'HYGIENE: BRUSH', type: 'OBJ', color: '#ffffff' }
};

// Fallback nếu không tìm thấy
function resolveName(originalClass) {
    if (CODENAMES[originalClass]) {
        return CODENAMES[originalClass];
    }
    return { 
        name: `UNKNOWN: ${originalClass.toUpperCase()}`, 
        type: 'UNK', 
        color: '#ffffff' 
    };
}

// --- 2. CORE CONFIG ---
const CONFIG = {
    SMOOTH: 0.25,
    IOU_THRESH: 0.35,
    CONFIDENCE: 0.55, // Tăng lên để lọc nhiễu
    MISS_LIMIT: 15
};

let state = {
    model: null,
    stream: null,
    facing: 'environment',
    tracks: [],
    lastTime: 0,
    fps: 0
};

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// --- 3. LOGIC (TRACKING & IOU) ---
function getIoU(box1, box2) {
    const [x1, y1, w1, h1] = box1;
    const [x2, y2, w2, h2] = box2;
    const xi1 = Math.max(x1, x2);
    const yi1 = Math.max(y1, y2);
    const xi2 = Math.min(x1 + w1, x2 + w2);
    const yi2 = Math.min(y1 + h1, y2 + h2);
    const inter = Math.max(0, xi2 - xi1) * Math.max(0, yi2 - yi1);
    return inter / ((w1*h1) + (w2*h2) - inter);
}

function lerp(s, e, t) { return (1-t)*s + t*e; }

function updateTracks(preds) {
    state.tracks.forEach(t => t.seen = false);

    preds.forEach(p => {
        if (p.score < CONFIG.CONFIDENCE) return;

        let best = null, maxIoU = 0;
        state.tracks.forEach(t => {
            if (t.rawClass === p.class) {
                const iou = getIoU(t.box, p.bbox);
                if (iou > maxIoU) { maxIoU = iou; best = t; }
            }
        });

        if (best && maxIoU > CONFIG.IOU_THRESH) {
            best.target = p.bbox;
            best.score = p.score;
            best.seen = true;
            best.miss = 0;
        } else {
            const info = resolveName(p.class);
            state.tracks.push({
                id: Math.random().toString(16).slice(2, 6).toUpperCase(),
                rawClass: p.class,
                displayName: info.name,
                color: info.color,
                score: p.score,
                box: [...p.bbox],
                target: [...p.bbox],
                seen: true,
                miss: 0,
                // Tạo số liệu giả ngẫu nhiên cho ngầu
                dist: (Math.random() * 5 + 1).toFixed(1) + 'M',
                scanLine: 0 
            });
        }
    });

    state.tracks = state.tracks.filter(t => {
        if (!t.seen) t.miss++;
        return t.miss < CONFIG.MISS_LIMIT;
    });
    
    document.getElementById('target-count').innerText = state.tracks.length;
}

// --- 4. RENDERER (HUD STYLE) ---
function drawHUD(track) {
    // Smooth movement
    track.box[0] = lerp(track.box[0], track.target[0], CONFIG.SMOOTH);
    track.box[1] = lerp(track.box[1], track.target[1], CONFIG.SMOOTH);
    track.box[2] = lerp(track.box[2], track.target[2], CONFIG.SMOOTH);
    track.box[3] = lerp(track.box[3], track.target[3], CONFIG.SMOOTH);

    const [x, y, w, h] = track.box;
    const color = track.color;
    
    // Fade out if missing
    ctx.globalAlpha = Math.max(0.2, 1 - (track.miss / CONFIG.MISS_LIMIT));
    
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.fillStyle = color;

    // 1. Vẽ 4 góc (Corner Brackets) thay vì full box
    const len = Math.min(w, h) * 0.2; // Độ dài góc
    
    // Top-Left
    ctx.beginPath(); ctx.moveTo(x, y + len); ctx.lineTo(x, y); ctx.lineTo(x + len, y); ctx.stroke();
    // Top-Right
    ctx.beginPath(); ctx.moveTo(x + w - len, y); ctx.lineTo(x + w, y); ctx.lineTo(x + w, y + len); ctx.stroke();
    // Bottom-Right
    ctx.beginPath(); ctx.moveTo(x + w, y + h - len); ctx.lineTo(x + w, y + h); ctx.lineTo(x + w - len, y + h); ctx.stroke();
    // Bottom-Left
    ctx.beginPath(); ctx.moveTo(x + len, y + h); ctx.lineTo(x, y + h); ctx.lineTo(x, y + h - len); ctx.stroke();

    // 2. Scan Line Effect (Chạy lên xuống trong box)
    track.scanLine += 2;
    if (track.scanLine > h) track.scanLine = 0;
    ctx.globalAlpha = 0.3 * ctx.globalAlpha;
    ctx.fillRect(x, y + track.scanLine, w, 2);
    ctx.globalAlpha = ctx.globalAlpha / 0.3; // Reset alpha

    // 3. Label & Data Block
    ctx.font = '12px "Share Tech Mono"';
    const label = `${track.displayName}`;
    const metrics = `ID:${track.id} | INTEG:${Math.round(track.score*100)}%`;
    
    // Background cho text
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.fillRect(x, y - 40, Math.max(w, 150), 35);
    
    // Text chính
    ctx.fillStyle = color;
    ctx.fillText(label, x + 5, y - 25);
    
    // Text phụ (nhỏ hơn)
    ctx.fillStyle = '#ccc';
    ctx.font = '10px "Share Tech Mono"';
    ctx.fillText(metrics, x + 5, y - 10);

    // 4. Connecting Line (Đường nối text vào box)
    ctx.beginPath();
    ctx.moveTo(x, y - 5);
    ctx.lineTo(x, y);
    ctx.stroke();

    // 5. Tọa độ giả lập bên cạnh box
    if (h > 100) {
        ctx.fillStyle = color;
        ctx.fillText(`Y:${Math.round(y)}`, x + w + 5, y + 20);
        ctx.fillText(`X:${Math.round(x)}`, x + w + 5, y + 35);
        ctx.fillText(`Z:${track.dist}`, x + w + 5, y + 50);
    }

    ctx.globalAlpha = 1.0;
}

function renderLoop() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    state.tracks.forEach(drawHUD);

    // Tính FPS
    const now = performance.now();
    const delta = now - state.lastTime;
    if (delta >= 1000) {
        state.fps = Math.round((1000/delta) * 60); // Ước lượng
        document.getElementById('fps-meter').innerText = 60; // WebGL vẽ 60fps
        state.lastTime = now;
    }

    requestAnimationFrame(renderLoop);
}

async function aiLoop() {
    if (!state.model) return;
    try {
        const preds = await state.model.detect(video);
        updateTracks(preds);
    } catch (e) {}
    requestAnimationFrame(aiLoop);
}

// --- 5. SETUP ---
async function main() {
    try {
        // Camera Setup
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: state.facing, width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: false
        });
        video.srcObject = stream;
        
        // Load Model (Dùng mobilenet_v2 thay vì lite để chính xác hơn)
        // Lưu ý: mobilenet_v2 nặng hơn lite một chút nhưng tốt hơn.
        state.model = await cocoSsd.load({ base: 'mobilenet_v2' });
        
        document.getElementById('loader').style.display = 'none';
        
        video.play();
        aiLoop();
        renderLoop();

    } catch (err) {
        document.getElementById('load-text').innerText = "ERROR: " + err.message;
        document.getElementById('load-text').style.color = 'red';
    }
}

function switchCamera() {
    state.facing = state.facing === 'user' ? 'environment' : 'user';
    main(); // Restart
}

function toggleMode() {
    // Chức năng mở rộng trong tương lai
    alert("MODE: HUD VISION [LOCKED]");
}

main();

</script>
</body>
</html>
